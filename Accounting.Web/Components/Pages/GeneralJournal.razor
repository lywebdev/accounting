@page "/general-journal"
@using Accounting.Core.Entities
@using Accounting.Core.Enums
@using MudBlazor
@inject IJournalQueryService JournalQueryService
@inject IJournalCommandService JournalCommandService
@inject IChartOfAccountsQueryService ChartQueryService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IStringLocalizer<SharedResources> Localizer
@inject ILogger<GeneralJournal> Logger
@implements IDisposable

<MudPaper Class="pa-4 mb-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
        <MudText Typo="Typo.h5">@Localizer["Journal_Title"]</MudText>
        <MudStack Row="true" Spacing="1">
            <MudTooltip Text="@Localizer["Journal_Tooltip_Add"]">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="() => OpenCreateDialogAsync()">
                    <MudIcon Icon="@Icons.Material.Filled.Add" Class="mr-2" />@Localizer["Journal_AddButton"]
                </MudButton>
            </MudTooltip>
            <MudTooltip Text="@Localizer["Journal_CopyLast_Tooltip"]">
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Disabled="!HasEntries" OnClick="CopyLastEntryAsync">
                    <MudIcon Icon="@Icons.Material.Filled.ContentCopy" Class="mr-2" />@Localizer["Journal_CopyLast"]
                </MudButton>
            </MudTooltip>
        </MudStack>
    </MudStack>

    <MudStack Row="true" Class="mt-4" Spacing="2">
        <MudDatePicker Date="_fromDate" DateChanged="OnFromDateChanged" Label="@Localizer["Journal_Filter_From"]" />
        <MudDatePicker Date="_toDate" DateChanged="OnToDateChanged" Label="@Localizer["Journal_Filter_To"]" />
    </MudStack>
</MudPaper>

<MudPaper Class="report-note">
    @Localizer["Journal_Note"]
</MudPaper>
<MudPaper Class="pa-4 mb-4 journal-guide">
    <MudText Typo="Typo.subtitle1" Class="mb-2">@Localizer["Journal_Guide_Title"]</MudText>
    <MudList Dense="true" T="string">
        <MudListItem T="string">@Localizer["Journal_Guide_WhatIsIt"]</MudListItem>
        <MudListItem T="string">@Localizer["Journal_Guide_WhenUse"]</MudListItem>
        <MudListItem T="string">@Localizer["Journal_Guide_HowTo"]</MudListItem>
    </MudList>
</MudPaper>
@if (_categorySummaries.Count > 0)
{
    <MudPaper Class="pa-4 mb-4">
        <MudText Typo="Typo.subtitle2" Class="mb-2">@Localizer["Journal_Summary_Title"]</MudText>
        <MudTable Items="_categorySummaries" Dense="true">
            <HeaderContent>
                <MudTh>@Localizer["Journal_Summary_Category"]</MudTh>
                <MudTh Class="text-end">@Localizer["Journal_Summary_Debit"]</MudTh>
                <MudTh Class="text-end">@Localizer["Journal_Summary_Credit"]</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@Localizer[$"Account_Category_{context.Category}"]</MudTd>
                <MudTd Class="text-end">@context.TotalDebit.ToString("N2")</MudTd>
                <MudTd Class="text-end">@context.TotalCredit.ToString("N2")</MudTd>
            </RowTemplate>
        </MudTable>
    </MudPaper>
}

@if (_isLoading)
{
    <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" />
}
else if (_entries.Count == 0)
{
    <MudText Typo="Typo.subtitle1">@Localizer["Journal_NoRecords"]</MudText>
}
else
{
    <MudTable Items="_entries" Dense="true" RowClassFunc='@((_, __) => "clickable-row")'>
        <HeaderContent>
            <MudTh>@Localizer["Journal_Table_Date"]</MudTh>
            <MudTh>@Localizer["Journal_Table_Reference"]</MudTh>
            <MudTh>@Localizer["Journal_Table_Memo"]</MudTh>
            <MudTh>@Localizer["Journal_Table_Debit"]</MudTh>
            <MudTh>@Localizer["Journal_Table_Credit"]</MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate Context="entry">
            <MudTd>@entry.EntryDate.ToString("yyyy-MM-dd")</MudTd>
            <MudTd>@entry.Reference</MudTd>
            <MudTd>@entry.Memo</MudTd>
            <MudTd>@entry.TotalDebit</MudTd>
            <MudTd>@entry.TotalCredit</MudTd>
            <MudTd>
                <MudTooltip Text="@Localizer["Journal_Tooltip_Delete"]">
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => DeleteEntryAsync(entry.Id)" />
                </MudTooltip>
            </MudTd>
        </RowTemplate>
        <ChildRowContent Context="entry">
            <MudPaper Class="pa-3">
                <MudTable Items="@entry.Lines" Dense="true">
                    <HeaderContent>
                        <MudTh>@Localizer["Journal_Lines_Account"]</MudTh>
                        <MudTh>@Localizer["Journal_Lines_Debit"]</MudTh>
                        <MudTh>@Localizer["Journal_Lines_Credit"]</MudTh>
                        <MudTh>@Localizer["Journal_Lines_Description"]</MudTh>
                    </HeaderContent>
                    <RowTemplate Context="line">
                        <MudTd>@line.AccountLabel</MudTd>
                        <MudTd>@line.Debit</MudTd>
                        <MudTd>@line.Credit</MudTd>
                        <MudTd>@line.Description</MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        </ChildRowContent>
    </MudTable>
}

@code {
    private readonly List<JournalEntryViewModel> _entries = new();
    private readonly List<JournalEntry> _rawEntries = new();
    private readonly List<CategorySummary> _categorySummaries = new();
    private readonly Dictionary<Guid, AccountCategory> _accountCategories = new();
    private readonly CancellationTokenSource _disposeCts = new();
    private CancellationTokenSource? _loadCts;
    private IReadOnlyList<JournalEntryDialog.AccountOption> _accounts = Array.Empty<JournalEntryDialog.AccountOption>();
    private bool _isLoading;
    private DateTime? _fromDate = DateTime.Today.AddMonths(-1);
    private DateTime? _toDate = DateTime.Today;
    private bool HasEntries => _entries.Count > 0;

    protected override async Task OnInitializedAsync()
    {
        var token = _disposeCts.Token;
        var accountEntities = await ChartQueryService.GetAsync(null, token);
        _accounts = accountEntities
            .Select(a => new JournalEntryDialog.AccountOption(a.Id, a.Number, a.Name))
            .ToList();
        _accountCategories.Clear();
        foreach (var account in accountEntities)
        {
            _accountCategories[account.Id] = account.Category;
        }
        await LoadEntriesAsync();
    }

    private async Task LoadEntriesAsync()
    {
        _isLoading = true;
        var token = BeginLoadCts();
        try
        {
            _entries.Clear();
            _rawEntries.Clear();
            var entries = await JournalQueryService.GetAsync(ConvertToDateOnly(_fromDate), ConvertToDateOnly(_toDate), token);
            foreach (var entry in entries)
            {
                _rawEntries.Add(entry);
                _entries.Add(JournalEntryViewModel.FromEntity(entry, _accounts));
            }
            UpdateCategorySummaries();
        }
        catch (OperationCanceledException)
        {
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load journal entries");
            Snackbar.Add(ex.Message, Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnFromDateChanged(DateTime? value)
    {
        _fromDate = value;
        await LoadEntriesAsync();
    }

    private async Task OnToDateChanged(DateTime? value)
    {
        _toDate = value;
        await LoadEntriesAsync();
    }

    private async Task OpenCreateDialogAsync(JournalEntryDialog.JournalEntryEditModel? seedModel = null)
    {
        var parameters = new DialogParameters
        {
            { nameof(JournalEntryDialog.Model), seedModel ?? new JournalEntryDialog.JournalEntryEditModel() },
            { nameof(JournalEntryDialog.Accounts), _accounts }
        };

        var options = new DialogOptions { MaxWidth = MaxWidth.ExtraLarge, FullWidth = true, CloseButton = true };
        var dialog = await DialogService.ShowAsync<JournalEntryDialog>(Localizer["Journal_Dialog_Title"], parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: JournalEntryDialog.JournalEntryEditModel model })
        {
            await CreateEntryAsync(model);
        }
    }

    private async Task CopyLastEntryAsync()
    {
        var last = _rawEntries.OrderByDescending(e => e.EntryDate).ThenByDescending(e => e.Reference).FirstOrDefault();
        if (last is null)
        {
            return;
        }

        var model = new JournalEntryDialog.JournalEntryEditModel
        {
            Reference = $"{last.Reference}-COPY",
            EntryDate = last.EntryDate,
            Memo = last.Memo
        };
        model.Lines.Clear();
        foreach (var line in last.Lines)
        {
            model.Lines.Add(new JournalEntryDialog.JournalEntryLineModel
            {
                AccountId = line.AccountId,
                Debit = line.Debit,
                Credit = line.Credit,
                Description = line.Description
            });
        }

        await OpenCreateDialogAsync(model);
    }

    private async Task CreateEntryAsync(JournalEntryDialog.JournalEntryEditModel model)
    {
        try
        {
            var lines = model.Lines.Select(l => new JournalEntryLine(l.AccountId!.Value, l.Debit, l.Credit, l.Description));
            await JournalCommandService.CreateAsync(model.Reference, model.EntryDate, model.Memo, lines, _disposeCts.Token);
            Snackbar.Add(Localizer["Journal_Snackbar_Create"].Value, Severity.Success);
            await LoadEntriesAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to create journal entry {Reference}", model.Reference);
            Snackbar.Add(ex.Message, Severity.Error);
        }
    }

    private void UpdateCategorySummaries()
    {
        _categorySummaries.Clear();
        if (_rawEntries.Count == 0)
        {
            return;
        }

        var totals = new Dictionary<AccountCategory, (decimal debit, decimal credit)>();
        foreach (var entry in _rawEntries)
        {
            foreach (var line in entry.Lines)
            {
                if (!_accountCategories.TryGetValue(line.AccountId, out var category))
                {
                    continue;
                }

                if (!totals.TryGetValue(category, out var agg))
                {
                    agg = (0m, 0m);
                }

                agg.debit += line.Debit;
                agg.credit += line.Credit;
                totals[category] = agg;
            }
        }

        foreach (var kvp in totals.OrderBy(k => k.Key))
        {
            _categorySummaries.Add(new CategorySummary(kvp.Key, kvp.Value.debit, kvp.Value.credit));
        }
    }

    private async Task DeleteEntryAsync(Guid entryId)
    {
        try
        {
            await JournalCommandService.DeleteAsync(entryId, _disposeCts.Token);
            Snackbar.Add(Localizer["Journal_Snackbar_Delete"].Value, Severity.Info);
            await LoadEntriesAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to delete journal entry {EntryId}", entryId);
            Snackbar.Add(ex.Message, Severity.Error);
        }
    }

    private CancellationToken BeginLoadCts()
    {
        _loadCts?.Cancel();
        _loadCts?.Dispose();
        _loadCts = CancellationTokenSource.CreateLinkedTokenSource(_disposeCts.Token);
        return _loadCts.Token;
    }

    public void Dispose()
    {
        _loadCts?.Cancel();
        _loadCts?.Dispose();
        _disposeCts.Cancel();
        _disposeCts.Dispose();
    }

    private sealed record JournalEntryViewModel(Guid Id, string Reference, DateOnly EntryDate, string? Memo, decimal TotalDebit, decimal TotalCredit, IReadOnlyList<JournalEntryLineViewModel> Lines)
    {
        public static JournalEntryViewModel FromEntity(JournalEntry entry, IReadOnlyCollection<JournalEntryDialog.AccountOption> accounts)
        {
            var lines = entry.Lines.Select(line =>
            {
                var accountLabel = accounts.FirstOrDefault(a => a.Id == line.AccountId) is { } account
                    ? $"{account.Number} - {account.Name}"
                    : line.AccountId.ToString();
                return new JournalEntryLineViewModel(accountLabel, line.Debit, line.Credit, line.Description);
            }).ToList();

            return new JournalEntryViewModel(entry.Id, entry.Reference, entry.EntryDate, entry.Memo, entry.TotalDebit, entry.TotalCredit, lines);
        }
    }

    private sealed record JournalEntryLineViewModel(string AccountLabel, decimal Debit, decimal Credit, string Description);
    private sealed record CategorySummary(AccountCategory Category, decimal TotalDebit, decimal TotalCredit);

    private static DateOnly? ConvertToDateOnly(DateTime? input)
        => input.HasValue ? DateOnly.FromDateTime(input.Value) : null;
}
