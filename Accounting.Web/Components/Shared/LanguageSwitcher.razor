@using System.Globalization
@using Microsoft.AspNetCore.Localization
@inject NavigationManager NavigationManager
@inject IStringLocalizer<SharedResources> Localizer
@inject IJSRuntime JsRuntime

<div class="language-switcher">
    <MudMenu Label="@CurrentLanguageLabel"
             Icon="@Icons.Material.Filled.Language"
             Variant="Variant.Filled"
             Dense="true"
             Class="language-switcher-chip"
             Color="Color.Inherit"
             AnchorOrigin="Origin.BottomRight"
             EndIcon="@Icons.Material.Filled.ArrowDropDown">
        <MudMenuItem OnClick="OnEnglishSelected">@EnglishLabel</MudMenuItem>
        <MudMenuItem OnClick="OnDutchSelected">@DutchLabel</MudMenuItem>
    </MudMenu>
</div>

@code {
    private string _selectedCulture = CultureInfo.CurrentUICulture.TwoLetterISOLanguageName;
    private string EnglishLabel => Localizer["Language_English"];
    private string DutchLabel => Localizer["Language_Dutch"];
    private string CurrentLanguageLabel => _selectedCulture == "nl" ? DutchLabel : EnglishLabel;

    private async Task OnCultureChanged(string culture)
    {
        if (string.IsNullOrWhiteSpace(culture))
        {
            return;
        }

        _selectedCulture = culture;
        var cookieValue = CookieRequestCultureProvider.MakeCookieValue(new RequestCulture(culture));
        await JsRuntime.InvokeVoidAsync("culture.set", cookieValue);

        var uri = new Uri(NavigationManager.Uri);
        var baseUri = uri.GetLeftPart(UriPartial.Path);
        NavigationManager.NavigateTo($"{baseUri}?culture={culture}&ui-culture={culture}", forceLoad: true);
    }

    private Task OnEnglishSelected() => OnCultureChanged("en");
    private Task OnDutchSelected() => OnCultureChanged("nl");
}
